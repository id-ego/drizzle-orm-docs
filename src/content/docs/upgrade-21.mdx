import Callout from '@mdx/Callout.astro';

## `0.21.0`으로 마이그레이션하는 방법

#### 1. drizzle-kit 명령어에서 모든 `:dialect` 접두사를 제거합니다.
예시: `drizzle-kit push:mysql`을 `drizzle-kit push`로 변경합니다.

#### 2. `drizzle.config.ts` 파일을 업데이트합니다:
 - `drizzle.config.ts`에 `dialect`를 추가합니다. 이제 필수 항목이며 `postgresql`, `mysql`, 또는 `sqlite` 중 하나를 사용할 수 있습니다.
 - `aws-data-api`, `turso`, `d1-http`(WIP), 또는 `expo`를 사용하는 경우에만 `driver`를 `drizzle.config.ts`에 추가합니다. 그렇지 않으면 `driver`를 `drizzle.config.ts`에서 제거할 수 있습니다.
 - `dbCredentials`에서 `connectionString` 또는 `uri`를 사용하고 있었다면, 이제 `url`을 사용해야 합니다.
    
```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    dialect: "sqlite", // "postgresql" | "mysql"
    driver: "turso", // optional and used only if `aws-data-api`, `turso`, `d1-http`(WIP) or `expo` are used
    dbCredentials: {
        url: ""
    }
})
```

#### 3. PostgreSQL 또는 SQLite를 사용 중이고 프로젝트에 마이그레이션이 생성되어 있는 경우, Drizzle이 모든 스냅샷을 버전 6으로 업그레이드할 수 있도록 `drizzle-kit up`을 실행해주세요.

<Callout>
  `0.21.0`에서 변경된 모든 내용은 여기에서 자세히 확인할 수 있습니다
</Callout>

## 변경사항

**❗ 스냅샷 업그레이드**

PostgreSQL 및 SQLite로 생성된 모든 스냅샷이 버전 6으로 업그레이드됩니다. `drizzle-kit up`을 실행하여 업그레이드하라는 메시지가 표시됩니다.

**❗ `drizzle-kit` CLI 명령어에서 :dialect 제거**

이제 다음과 같은 명령어를 사용할 수 있습니다:

- `drizzle-kit generate`
- `drizzle-kit push`
- 등등

dialect를 지정하지 않아도 됩니다. 이 매개변수는 `drizzle.config.ts`로 이동되었습니다.

**❗ `drizzle.config` 업데이트**

- `dialect`은 이제 필수입니다. 연결하려는 데이터베이스 dialect를 지정하세요. 옵션은 `mysql`, `postgresql`, 또는 `sqlite`입니다.
- `driver`는 선택 사항이 되었으며, 각각 다른 `dbCredentials` 설정을 가진 특정 드라이버를 갖게 됩니다. 사용 가능한 드라이버는:
  - `aws-data-api`
  - `turso`
  - `d1-http` - 현재 작업 중
  - `expo`
- `url` - 기존의 `connectionString` 및 `uri`를 통합한 매개변수입니다.
- `migrations` - migrate 명령어를 위한 커스텀 테이블과 스키마를 지정하는 새로운 객체 매개변수입니다:
  - `table` - drizzle이 마이그레이션을 저장할 커스텀 테이블입니다.
  - `schema` - drizzle이 마이그레이션을 저장할 커스텀 스키마입니다 (PostgreSQL만 해당).

모든 신규 및 업데이트된 명령어의 사용 예시
```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    dialect: "sqlite", // "postgresql" | "mysql"
    driver: "turso"
    dbCredentials: {
        url: ""
    },
    migration: {
        table: "migrations",
        schema: "public"
    }
})
```

Drizzle 드라이버 선택은 다음 전략을 따릅니다:

`driver`가 지정된 경우, 쿼리에 이 드라이버를 사용합니다.

driver가 지정되지 않은 경우:

- `postgresql` dialect의 경우, Drizzle은:
  - `pg` 드라이버가 설치되어 있는지 확인하고 사용합니다.
  - 없으면 `postgres` 드라이버를 찾아서 사용합니다.
  - 여전히 찾지 못하면 `@vercel/postgres`를 찾습니다.
  - 그 다음 `@neondatabase/serverless`를 시도합니다.
  - 아무것도 찾지 못하면 오류가 발생합니다.

- `mysql` dialect의 경우, Drizzle은:
  - `mysql2` 드라이버가 설치되어 있는지 확인하고 사용합니다.
  - 없으면 `@planetscale/database`를 찾아서 사용합니다.
  - 아무것도 찾지 못하면 오류가 발생합니다.

- `sqlite` dialect의 경우, Drizzle은:
  - `@libsql/client` 드라이버가 설치되어 있는지 확인하고 사용합니다.
  - 없으면 `better-sqlite3`를 찾아서 사용합니다.
  - 아무것도 찾지 못하면 오류가 발생합니다.

**❗ MySQL 스키마/데이터베이스는 더 이상 drizzle-kit에서 지원되지 않습니다**

Drizzle Kit은 drizzle 스키마 파일에 있는 추가 스키마/데이터베이스에 대한 스키마 변경을 처리하지 않습니다.

# 새로운 기능

**🎉 풀 관계**

Drizzle은 이제 외래 키 정보를 추출하여 `relations` 객체로 변환하여 데이터베이스에서 `relations`를 가져옵니다. 인트로스펙션이 완료된 후 `out` 폴더에서 `relations.ts` 파일을 볼 수 있습니다.

관계에 대한 자세한 내용은 [문서](/docs/rqb#declaring-relations)를 확인하세요.


**🎉 생성된 마이그레이션의 커스텀 이름**

마이그레이션 이름을 지정하려면 `--name <name>`을 사용해야 합니다.

사용법
```
drizzle-kit generate --name init_db
```

**🎉 새로운 명령어 `migrate`**

이제 `drizzle-kit`에서 직접 생성된 마이그레이션을 데이터베이스에 적용할 수 있습니다.

사용법
```
drizzle-kit migrate
```

기본적으로 drizzle-kit은 마이그레이션 데이터 항목을 `__drizzle_migrations` 테이블에 저장하며, PostgreSQL의 경우 `drizzle` 스키마에 저장합니다. 이를 변경하려면 `drizzle.config.ts`에서 수정 사항을 지정해야 합니다.

```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    migrations: {
        table: "migrations",
        schema: "public"
    }
})
```