import Npm from "@mdx/Npm.astro";
import Callout from "@mdx/Callout.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> PlanetScale Postgres

<Prerequisites>

- Drizzle 데이터베이스 [연결 기본 사항](/docs/connect-overview)
- PlanetScale Postgres 데이터베이스 - [문서](https://planetscale.com/docs/postgres)
- Drizzle PostgreSQL 드라이버 - [문서](/docs/get-started-postgresql)

</Prerequisites>

PlanetScale은 MySQL(Vitess)과 PostgreSQL 데이터베이스를 모두 제공합니다. 이 페이지는 PlanetScale Postgres 연결을 다룹니다.

PlanetScale MySQL의 경우 [PlanetScale MySQL 연결 가이드](/docs/connect-planetscale)를 참조하세요.

Drizzle ORM에서 PlanetScale Postgres에 연결하는 방법:

- 표준 `node-postgres` 드라이버 사용
- 서버리스 환경을 위한 `@neondatabase/serverless` 드라이버 사용

PlanetScale Postgres 데이터베이스 생성 및 자격 증명 획득에 대한 자세한 내용은 [PlanetScale Postgres 문서](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle)를 참조하세요.

## node-postgres

#### Step 1 - 패키지 설치

<Npm>drizzle-orm pg -D drizzle-kit @types/pg</Npm>

#### Step 2 - 드라이버 초기화 및 쿼리 실행

<CodeTabs items={["Connection URL", "With config", "With existing client"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');

````
```typescript copy
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle({
  connection: {
    connectionString: process.env.DATABASE_URL,
    ssl: true
  }
});

const result = await db.execute('select 1');
````

```typescript copy
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });

const result = await db.execute("select 1");
```

</CodeTabs>

## Neon serverless 드라이버

PlanetScale Postgres는 [Neon serverless 드라이버](https://planetscale.com/docs/postgres/connecting/neon-serverless-driver)를 통한 연결도 지원합니다. Vercel Functions, Cloudflare Workers, AWS Lambda와 같은 서버리스 환경에 적합합니다.

드라이버는 두 가지 모드를 지원합니다:

- **HTTP 모드** — 단일 쿼리 및 비대화형 트랜잭션에 더 빠름
- **WebSocket 모드** — 대화형 트랜잭션 또는 세션 기반 기능에 필수

#### Step 1 - 패키지 설치

<Npm>drizzle-orm @neondatabase/serverless -D drizzle-kit</Npm>

#### Step 2 - 드라이버 초기화 및 쿼리 실행

<CodeTabs items={["Neon HTTP", "Neon WebSockets"]}>
```typescript copy
import { neon, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

// PlanetScale Postgres 연결에 필요
neonConfig.fetchEndpoint = (host) => `https://${host}/sql`;

const sql = neon(process.env.DATABASE_URL!);
const db = drizzle({ client: sql });

const result = await db.execute('select 1');

````
<Section>
```typescript copy
import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';

// PlanetScale Postgres 연결에 필요
neonConfig.pipelineConnect = false;
neonConfig.wsProxy = (host, port) => `${host}/v2?address=${host}:${port}`;

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute('select 1');
````

```typescript copy
// Node.js 환경용 - 'ws' 패키지 설치 필요
import ws from "ws";
import { Pool, neonConfig } from "@neondatabase/serverless";
import { drizzle } from "drizzle-orm/neon-serverless";

neonConfig.webSocketConstructor = ws;
// PlanetScale Postgres 연결에 필요
neonConfig.pipelineConnect = false;
neonConfig.wsProxy = (host, port) => `${host}/v2?address=${host}:${port}`;

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute("select 1");
```

</Section>
</CodeTabs>

<Callout title="연결 URL 형식">
  {`postgresql://{username}:{password}@{host}:{port}/postgres?sslmode=verify-full`}
</Callout>

<Callout title="연결 포트" type="info">
  PlanetScale Postgres는 두 가지 연결 포트를 지원합니다:

`5432`: PostgreSQL 직접 연결. 총 연결 수는 클러스터의 `max_connections` 설정으로 제한됩니다.

`6432`: 연결 풀링을 위한 PgBouncer를 통한 연결. 동시 연결이 많은 경우 권장됩니다.

  </Callout>

#### 다음 단계

<WhatsNextPostgres />
