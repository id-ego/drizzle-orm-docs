---
title: Gel ì¸ì¦ í™•ì¥
slug: gel-ext-auth
---
import Prerequisites from "@mdx/Prerequisites.astro";
import Callout from "@mdx/Callout.astro";
import Npx from "@mdx/Npx.astro";

<Prerequisites>
- [Gel](/docs/get-started-gel) ì‹œì‘í•˜ê¸°
- [drizzle-kit pull](/docs/drizzle-kit-pull) ì‚¬ìš©í•˜ê¸°
</Prerequisites>

#### ë‹¨ê³„ 1 - Gel ì¸ì¦ ìŠ¤í‚¤ë§ˆ ì •ì˜

`dbschema/default.esdl` íŒŒì¼ì— auth í™•ì¥ì´ í¬í•¨ëœ Gel ìŠ¤í‚¤ë§ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤

```esdl
using extension auth;

module default {
  global current_user := (
    assert_single((
      select User { id, username, email }
      filter .identity = global ext::auth::ClientTokenIdentity
    ))
  );

  type User {
    required identity: ext::auth::Identity;
    required username: str;
    required email: str;
  }
}
```

#### ë‹¨ê³„ 2 - ë°ì´í„°ë² ì´ìŠ¤ì— Gel ìŠ¤í‚¤ë§ˆ í‘¸ì‹œ

Gel ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±:
```bash
gel migration create
```

ë°ì´í„°ë² ì´ìŠ¤ì— Gel ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©:
```bash
gel migration apply
```

#### ë‹¨ê³„ 3 - Drizzle ì„¤ì • íŒŒì¼ ì„¤ì •

**Drizzle config** - [Drizzle Kit](/docs/kit-overview)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì„¤ì • íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë”, ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
  // drizzle-kitì—ì„œ auth ìŠ¤í‚¤ë§ˆ í™œì„±í™”
  schemaFilter: ['ext::auth', 'public']
});
```

#### ë‹¨ê³„ 4 - Gel íƒ€ì…ì„ Drizzle ìŠ¤í‚¤ë§ˆë¡œ í’€

ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ í’€í•©ë‹ˆë‹¤:
<Npx>
drizzle-kit pull
</Npx>

ë‹¤ìŒì€ ìƒì„±ëœ schema.ts íŒŒì¼ì˜ ì˜ˆì‹œì…ë‹ˆë‹¤:

<Callout type="warning">
`ext::auth`ì—ì„œ `Identity` í…Œì´ë¸”ë¿ë§Œ ì•„ë‹ˆë¼ ë” ë§ì€ í…Œì´ë¸”ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. Drizzleì€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë“  `auth` í…Œì´ë¸”ì„ í’€í•©ë‹ˆë‹¤. ì•„ë˜ ì˜ˆì‹œëŠ” ê·¸ ì¤‘ í•˜ë‚˜ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
</Callout>

```ts
import { gelTable, uniqueIndex, uuid, text, gelSchema, timestamptz, foreignKey } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const extauth = gelSchema('ext::auth');

export const identityInExtauth = extauth.table('Identity', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	createdAt: timestamptz('created_at').default(sql`(clock_timestamp())`).notNull(),
	issuer: text().notNull(),
	modifiedAt: timestamptz('modified_at').notNull(),
	subject: text().notNull(),
}, (table) => [
	uniqueIndex('6bc2dd19-bce4-5810-bb1b-7007afe97a11;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
]);

export const user = gelTable('User', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	email: text().notNull(),
	identityId: uuid('identity_id').notNull(),
	username: text().notNull(),
}, (table) => [
	uniqueIndex('d504514c-26a7-11f0-b836-81aa188c0abe;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
	foreignKey({
		columns: [table.identityId],
		foreignColumns: [identityInExtauth.id],
		name: 'User_fk_identity',
	}),
]);
```

ğŸ‰ ì´ì œ ì¿¼ë¦¬ì—ì„œ `auth` í…Œì´ë¸”ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!