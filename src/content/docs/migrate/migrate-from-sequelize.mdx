---
title: "Sequelizeì—ì„œ Drizzleë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"
---
import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";

## ì‹œì‘í•˜ê¸°

ì´ ê°€ì´ë“œëŠ” ê¸°ë³¸ì ì¸ **Sequelize** í”„ë¡œì íŠ¸ë¥¼ **Drizzle ORM**ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ê°„ë‹¨í•œ ì ‘ê·¼ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆì œëŠ” `PostgreSQL`ì— ì¤‘ì ì„ ë‘ê³  ìˆì§€ë§Œ, ë‹¤ë¥¸ ì§€ì›ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ í”„ë¡œì„¸ìŠ¤ëŠ” ìœ ì‚¬í•©ë‹ˆë‹¤.

### ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤ ê°œìš”

ì• í”Œë¦¬ì¼€ì´ì…˜ íƒ€ì…ì´ë‚˜ API ë ˆì´ì–´ì— ê´€ê³„ì—†ì´, **Sequelize**ì—ì„œ **Drizzle ORM**ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë‹¨ê³„ëŠ” ì¼ê´€ë©ë‹ˆë‹¤:

1. **Drizzle ORM** & **Drizzle Kit** ì„¤ì¹˜
2. **Drizzle config** íŒŒì¼ ì„¤ì •
3. ë°ì´í„°ë² ì´ìŠ¤ ì¸íŠ¸ë¡œìŠ¤í™ì…˜
4. **Drizzle ORM**ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°
5. **Sequelize** ì¿¼ë¦¬ë¥¼ **Drizzle ORM** ì¿¼ë¦¬ë¡œ ì „í™˜

ì´ëŸ¬í•œ ë‹¨ê³„ëŠ” REST API(ì˜ˆ: Express, Koa ë˜ëŠ” NestJS)ë¥¼ ê°œë°œí•˜ë“ , ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ì‘ìš©ì„ ìœ„í•´ **Sequelize**ë¥¼ í™œìš©í•˜ëŠ” ë‹¤ë¥¸ íƒ€ì…ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•˜ë“  ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

## Sequelize í”„ë¡œì íŠ¸ ê°œìš”

ì´ ê°€ì´ë“œì—ì„œëŠ” `Express`ë¡œ êµ¬ì¶•ëœ REST APIë¥¼ **Drizzle ORM**ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ìƒ˜í”Œ í”„ë¡œì íŠ¸ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ë„¤ ê°œì˜ ì—”í‹°í‹°ê°€ ìˆìŠµë‹ˆë‹¤:

```typescript collapsable copy filename="src/db/models/supplier.ts"
import { DataTypes, Model } from 'sequelize';
import { Product } from './product';
import { sequelize } from '../db';

export class Supplier extends Model {}

Supplier.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    companyName: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    city: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    country: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'suppliers',
    modelName: 'Supplier',
    timestamps: false,
  },
);

Supplier.hasMany(Product, {
  foreignKey: 'supplierId',
});

Product.belongsTo(Supplier, {
  foreignKey: 'supplierId',
  targetKey: 'id',
});
```

```typescript collapsable copy filename="src/db/models/product.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Product extends Model {}

Product.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    name: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    supplierId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      references: {
        model: 'suppliers',
        key: 'id',
      },
      field: 'supplierId',
    },
    unitPrice: {
      type: DataTypes.DECIMAL,
      allowNull: false,
    },
    unitsInStock: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'products',
    modelName: 'Product',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Order extends Model {}

Order.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    orderDate: {
      type: DataTypes.DATE,
      allowNull: false,
    },
    shippedDate: {
      type: DataTypes.DATE,
      allowNull: true,
    },
    shipAddress: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    shipPostalCode: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    shipCountry: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'orders',
    modelName: 'Order',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order-detail.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';
import { Order } from './order';
import { Product } from './product';

export class OrderDetail extends Model {}

OrderDetail.init(
  {
    orderId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Order,
        key: 'id',
      },
      field: 'orderId',
    },
    productId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Product,
        key: 'id',
      },
      field: 'productId',
    },
    quantity: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'order_details',
    modelName: 'OrderDetail',
    timestamps: false,
  },
);

Order.hasMany(OrderDetail, { foreignKey: 'orderId', as: 'details' });
OrderDetail.belongsTo(Order, { foreignKey: 'orderId' });

Product.hasMany(OrderDetail, { foreignKey: 'productId', as: 'details' });
OrderDetail.belongsTo(Product, { foreignKey: 'productId' });

Order.belongsToMany(Product, {
  through: OrderDetail,
  foreignKey: 'orderId',
  as: 'products',
  targetKey: 'id',
});
Product.belongsToMany(Order, {
  through: OrderDetail,
  foreignKey: 'productId',
  as: 'orders',
  targetKey: 'id',
});
```

ëª¨ë¸ì€ ë‹¤ìŒê³¼ ê°™ì€ ê´€ê³„ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤:

1. `Supplier`ì™€ `Product` ê°„ì˜ `one-to-many`
2. `Order`ì™€ `Product` ê°„ì˜ `many-to-many`

`many-to-many` ê´€ê³„ë¥¼ ìœ„í•´ ì¡°ì¸ í…Œì´ë¸” `order_details`ë¥¼ ìƒì„±í•˜ë¯€ë¡œ, `Order`ì™€ `Product` ì—”í‹°í‹°ëŠ” `OrderDetail` ì—”í‹°í‹°ì™€ `one-to-many` ê´€ê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

í•´ë‹¹ í…Œì´ë¸”ë“¤ì€ Sequelize ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. SequelizeëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìë™ ìƒì„±ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

```javascript collapsable copy filename="src/db/migrations/20231220152726-init.js"
'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('suppliers', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      companyName: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      city: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      country: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('products', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      name: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      supplierId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: {
          model: 'suppliers',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL',
      },
      unitPrice: {
        type: Sequelize.DECIMAL,
        allowNull: false,
      },
      unitsInStock: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });

    await queryInterface.createTable('orders', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      orderDate: {
        type: Sequelize.DATE,
        allowNull: false,
      },
      shippedDate: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      shipAddress: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      shipPostalCode: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      shipCountry: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('order_details', {
      orderId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'orders',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      productId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'products',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      quantity: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable('order_details');
    await queryInterface.dropTable('orders');
    await queryInterface.dropTable('products');
    await queryInterface.dropTable('suppliers');
  },
};
```

ì´ ê°€ì´ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```text
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”‚  â”” ğŸ“œ 20231220152726-init.js
 â”‚  â”‚  â”œ ğŸ“‚ models
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order-detail.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ product.ts
 â”‚  â”‚  â”‚  â”” ğŸ“œ supplier.ts
 â”‚  â”‚  â”œ ğŸ“œ db.ts
 â”‚  â”‚  â”” ğŸ“œ config.js
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ .sequelizerc
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### Drizzle ORM & Drizzle Kit ì„¤ì¹˜

ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” ë“œë¼ì´ë²„ë¡œ ì‚¬ìš©í•  **Drizzle ORM**ê³¼ `pg` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‘ ë²ˆì§¸ ë‹¨ê³„ëŠ” **Drizzle Kit**ê³¼ `pg`ìš© íƒ€ì…ì„ ì„¤ì¹˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. [Drizzle Kit](/docs/kit-overview)ì€ ìë™ SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ë° ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘ì„ ìœ„í•œ CLI ë„êµ¬ì…ë‹ˆë‹¤. 

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### Drizzle config íŒŒì¼ ì„¤ì •

**Drizzle config**ëŠ” **Drizzle Kit**ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì„¤ì • íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë” ë° ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”:

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // make sure to install dotenv package
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  out: './src/drizzle',
  schema: './src/drizzle/schema.ts',
  dbCredentials: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT!),
    user: process.env.DB_USERNAME!,
    password: process.env.DB_PASSWORD!,
    database: process.env.DB_NAME!,
  },
  // Print all statements
  verbose: true,
  // Always ask for confirmation
  strict: true,
});
```

#### ë°ì´í„°ë² ì´ìŠ¤ ì¸íŠ¸ë¡œìŠ¤í™ì…˜

**Drizzle Kit**ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¸íŠ¸ë¡œìŠ¤í™ì…˜í•˜ê³  ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” CLI ëª…ë ¹ì„ ì œê³µí•©ë‹ˆë‹¤. ìŠ¤í‚¤ë§ˆ íŒŒì¼ì€ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”, ì»¬ëŸ¼, ê´€ê³„ ë° ì¸ë±ìŠ¤ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

```bash
npx drizzle-kit introspect
```

ì´ ëª…ë ¹ì€ src/drizzle í´ë”ì— schema.ts íŒŒì¼ê³¼ ìŠ¤ëƒ…ìƒ·, ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.

```typescript collapsable copy filename="src/drizzle/schema.ts"
import {
  pgTable,
  varchar,
  serial,
  text,
  foreignKey,
  integer,
  numeric,
  timestamp,
  primaryKey,
} from 'drizzle-orm/pg-core';
import { relations, sql } from 'drizzle-orm';

export const sequelizeMeta = pgTable('SequelizeMeta', {
  name: varchar('name', { length: 255 }).primaryKey().notNull(),
});

export const suppliers = pgTable('suppliers', {
  id: serial('id').primaryKey().notNull(),
  companyName: text('companyName').notNull(),
  city: text('city'),
  country: text('country').notNull(),
});

export const products = pgTable('products', {
  id: serial('id').primaryKey().notNull(),
  name: text('name').notNull(),
  supplierId: integer('supplierId')
    .notNull()
    .references(() => suppliers.id, { onDelete: 'set null', onUpdate: 'cascade' }),
  unitPrice: numeric('unitPrice').notNull(),
  unitsInStock: integer('unitsInStock').notNull(),
});

export const orders = pgTable('orders', {
  id: serial('id').primaryKey().notNull(),
  orderDate: timestamp('orderDate', { withTimezone: true, mode: 'string' }).notNull(),
  shippedDate: timestamp('shippedDate', { withTimezone: true, mode: 'string' }),
  shipAddress: text('shipAddress').notNull(),
  shipPostalCode: text('shipPostalCode'),
  shipCountry: text('shipCountry').notNull(),
});

export const orderDetails = pgTable(
  'order_details',
  {
    orderId: integer('orderId')
      .notNull()
      .references(() => orders.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    productId: integer('productId')
      .notNull()
      .references(() => products.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    quantity: integer('quantity').notNull(),
  },
  (table) => [
    primaryKey({ columns: [table.orderId, table.productId], name: 'order_details_pkey' })
  ]
);
```

```sql collapsable copy filename="src/drizzle/0000_high_rhodey.sql"
-- Current sql file was generated after introspecting the database

CREATE TABLE IF NOT EXISTS "SequelizeMeta" (
	"name" varchar(255) PRIMARY KEY NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "suppliers" (
	"id" serial PRIMARY KEY NOT NULL,
	"companyName" text NOT NULL,
	"city" text,
	"country" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "products" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"supplierId" integer NOT NULL,
	"unitPrice" numeric NOT NULL,
	"unitsInStock" integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "orders" (
	"id" serial PRIMARY KEY NOT NULL,
	"orderDate" timestamp with time zone NOT NULL,
	"shippedDate" timestamp with time zone,
	"shipAddress" text NOT NULL,
	"shipPostalCode" text,
	"shipCountry" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "order_details" (
	"orderId" integer NOT NULL,
	"productId" integer NOT NULL,
	"quantity" integer NOT NULL,
	CONSTRAINT order_details_pkey PRIMARY KEY("orderId","productId")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "products" ADD CONSTRAINT "products_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE set null ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

ë˜í•œ, ê´€ê³„í˜• ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ê´€ê³„í˜• í…Œì´ë¸”ë¡œ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤:

```typescript copy filename="src/drizzle/schema.ts"
// ...other imports
import { relations } from 'drizzle-orm';

// ...other tables 
export const suppliersRelations = relations(suppliers, ({ many }) => ({
  products: many(products),
}));

export const productsRelations = relations(products, ({ one, many }) => ({
  supplier: one(suppliers, { fields: [products.supplierId], references: [suppliers.id] }),
  orderDetails: many(orderDetails),
}));

export const ordersRelations = relations(orders, ({ many }) => ({
  orderDetails: many(orderDetails),
}));

export const orderDetailsRelations = relations(orderDetails, ({ one }) => ({
  order: one(orders, { fields: [orderDetails.orderId], references: [orders.id] }),
  product: one(products, { fields: [orderDetails.productId], references: [products.id] }),
}));
```

ì´ì œ ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

```text
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ drizzle
 â”‚  â”‚  â”œ ğŸ“‚ meta
 |  |  |  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”‚  â”œ ğŸ“œ 0000_lush_lenny_balinger.sql
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ tsconfig.json
```

#### Drizzle ORMì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°

`src/drizzle` í´ë”ì— `db.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ êµ¬ì„±í•˜ì„¸ìš”:

```typescript copy filename="src/drizzle/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import * as schema from './schema';

export const client = new Client({
  host: process.env.DB_HOST!,
  port: Number(process.env.DB_PORT!),
  user: process.env.DB_USERNAME!,
  password: process.env.DB_PASSWORD!,
  database: process.env.DB_NAME!,
});

// { schema } is used for relational queries
export const db = drizzle({ client, schema });
```

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { client, db } from './drizzle/db';
import { resolve } from 'node:path';
import { migrate } from 'drizzle-orm/node-postgres/migrator';


(async () => {
  await client.connect();

  // This command run all migrations from the migrations folder and apply changes to the database
  await migrate(db, { migrationsFolder: resolve(__dirname, './drizzle') });

  // ... start your application
})();
```

#### Sequelize ì¿¼ë¦¬ë¥¼ Drizzle ORM ì¿¼ë¦¬ë¡œ ì „í™˜

ì´ ì„¹ì…˜ì—ì„œëŠ” **Sequelize**ì˜ ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ **Drizzle ORM**ìœ¼ë¡œ êµì²´í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

##### ì‚½ì… ì¿¼ë¦¬ êµì²´

`suppliers` ë° `products` í…Œì´ë¸”ì— ìƒˆ í–‰ì„ ì‚½ì…í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

1. `POST /suppliers`
```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const suppliers = await Supplier.bulkCreate([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/supplier.controller.ts"
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

await db.insert(suppliers).values([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

2. `POST /products`

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';

const products = await Product.bulkCreate([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: 10,
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: 25,
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: 50,
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: 100,
    unitsInStock: 2,
  },
]);
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

`unitPrice` í•„ë“œì— ì£¼ì˜í•˜ì„¸ìš”. **Sequelize**ì—ì„œëŠ” `number` íƒ€ì…ì´ì§€ë§Œ, **Drizzle ORM**ì—ì„œëŠ” `string` íƒ€ì…ìœ¼ë¡œ, `number` íƒ€ì…ê³¼ ë‹¬ë¦¬ ì†Œìˆ˜ì  ì´í•˜ 16383ìë¦¬ ì´ìƒì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
await db.insert(products).values([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: '10',
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: '25',
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: '50',
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: '100',
    unitsInStock: 2,
  },
]);
```

##### ì¡°íšŒ ì¿¼ë¦¬ êµì²´

ì´ ì„¹ì…˜ì—ì„œëŠ” ë‹¨ì¼ í–‰ ì¡°íšŒ, ë‹¤ì¤‘ í–‰ ì¡°íšŒ, í–‰ ì¹´ìš´íŠ¸, í–‰ í•„í„°ë§, í…Œì´ë¸” ì¡°ì¸ ë° ê²°ê³¼ í˜ì´ì§€ë„¤ì´ì…˜ ë°©ë²•ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

1. `GET /products/:id`

**Sequelize**ì—ì„œëŠ” ì‘ë‹µ íƒ€ì…ì´ ì—„ê²©í•˜ê²Œ íƒ€ì…ì´ ì§€ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê´€ê³„ë¥¼ í¬í•¨í•˜ê±°ë‚˜ ëª¨ë“  í•„ë“œ ëŒ€ì‹  ì¼ë¶€ í•„ë“œë§Œ ì„ íƒí•˜ë”ë¼ë„ ì´ëŸ¬í•œ ë³€ê²½ì‚¬í•­ì€ ì‘ë‹µ íƒ€ì…ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const response = await Product.findByPk(id, {
  include: Supplier,
});
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// or you can use relational queries
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

**Drizzle ORM**ì—ì„œëŠ” ì‘ë‹µ íƒ€ì…ì´ select ê°ì²´ì— ì§€ì •ëœ ë‚´ìš©ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ë¯€ë¡œ, `supplier` ê´€ê³„ë¥¼ í¬í•¨í•˜ëŠ” ê²ƒì´ ì™„ì „íˆ íƒ€ì… ì•ˆì „í•©ë‹ˆë‹¤.

```typescript
// response type
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

**Sequelize**ì—ì„œëŠ” ì„ íƒí•˜ë ¤ëŠ” í•„ë“œë¥¼ ì§€ì •í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê²°ê³¼ê°€ íƒ€ì… ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Op } from 'sequelize';

const { rows, count } = await Product.findAndCountAll({
  limit: 10,
  offset: 0,
  attributes: ['id', 'name', 'unitPrice', 'unitsInStock'],
  where: {
    name: {
      [Op.iLike]: `%test%`,
    },
  },
});
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// or you can use relational queries
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

**Drizzle ORM**ì—ì„œëŠ” ê²°ê³¼ê°€ ì—„ê²©í•˜ê²Œ íƒ€ì… ì•ˆì „í•˜ë©°, ì„ íƒí•œ í•„ë“œê°€ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜ë©ë‹ˆë‹¤.

```typescript
// response type
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

**Sequelize**ì—ì„œëŠ” `findByPk`ì™€ ê°™ì€ ë©”ì„œë“œë¡œ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íƒ€ì… ì•ˆì „í•˜ì§€ ì•Šì€ raw ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” `orders` í…Œì´ë¸”ì—ì„œ `id`, `orderDate` ë° `shipCountry` í•„ë“œë¥¼ ì„ íƒí•˜ê³ , `ì§‘ê³„ í•¨ìˆ˜`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ë¬¸ì˜ `totalPrice`, ì£¼ë¬¸ ë‚´ ì œí’ˆì˜ `totalQuantity` ë° ì£¼ë¬¸ ë‚´ `totalProducts`ë¥¼ ê³„ì‚°í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

```typescript copy filename="src/controllers/order.controller.ts"
import { sequelize } from '../db/db';
import { QueryTypes } from 'sequelize';

const { id } = req.params;

const response = await sequelize.query(
      `
SELECT 
  orders.id,
  orders."orderDate",
  orders."shipCountry",
  SUM(products."unitPrice" * order_details.quantity)::float AS "totalPrice",
  SUM(order_details.quantity)::int AS "totalQuantity",
  COUNT(order_details."productId")::int AS "totalProducts"
FROM orders
LEFT JOIN order_details ON orders.id = order_details."orderId"
LEFT JOIN products ON order_details."productId" = products.id
WHERE orders.id = :orderId
GROUP BY orders.id
`,
      {
        replacements: { orderId: id },
        type: QueryTypes.SELECT,
      },
    );
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql<number>`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql<number>`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql<number>`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

**Drizzle ORM**ì—ì„œëŠ” ì§‘ê³„ë„ íƒ€ì… ì•ˆì „í•œ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

```typescript
// response type
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**ì°¸ê³ :** í˜„ì¬ ê´€ê³„í˜• ì¿¼ë¦¬ì—ì„œëŠ” ì§‘ê³„ê°€ ì§€ì›ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ `ì½”ì–´ ì¿¼ë¦¬`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

##### ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ êµì²´

ì´ ì„¹ì…˜ì—ì„œëŠ” ì—¬ëŸ¬ í–‰ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

1. `PATCH /suppliers/:id`

```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const supplier = await Supplier.findByPk(1);
if (!supplier) {
  throw new Error('Supplier not found');
}

supplier.set({
  city: 'TestCity1Updated',
  country: 'TestCountry1Updated',
});

await supplier.save();
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```

##### ì‚­ì œ ì¿¼ë¦¬ êµì²´

ì´ ì„¹ì…˜ì—ì„œëŠ” íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ í–‰ê³¼ ì—¬ëŸ¬ í–‰ì„ ì‚­ì œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import { Order } from '../db/models/order';
import { OrderDetail } from '../db/models/order-detail';
import { sequelize } from '../db/db';

const { id } = req.params;

try {
  const order = await Order.findByPk(id);
  if (!order) {
    throw new Error('Order not found');
  }

  await sequelize.transaction(async (t) => {
    await OrderDetail.destroy({
      where: {
        orderId: id,
      },
      transaction: t,
    });

    await order.destroy({ transaction: t });
  });
} catch (e) {
  console.error(e);
}
```

**Drizzle ORM**ì—ì„œëŠ” ì¿¼ë¦¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤:

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```

</Steps>
