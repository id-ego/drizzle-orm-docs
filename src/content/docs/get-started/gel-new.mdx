import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# Drizzleê³¼ Gel ì‹œì‘í•˜ê¸°

<Prerequisites>
  - **tsx** - TypeScript íŒŒì¼ì„ ì‹¤í–‰í•˜ëŠ” íŒ¨í‚¤ì§€ - [ìì„¸íˆ ë³´ê¸°](https://tsx.is/)
  - **gel-js** - Gel ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¿¼ë¦¬í•˜ëŠ” íŒ¨í‚¤ì§€ - [ìì„¸íˆ ë³´ê¸°](https://github.com/geldata/gel-js)
</Prerequisites>

Drizzleì€ `gel` í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ Gel ì—°ê²°ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤.

ì´ê²ƒì€ í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°ì…ë‹ˆë‹¤. `src` ë””ë ‰í† ë¦¬ì—ëŠ” `index.ts`ì— í…Œì´ë¸” ì •ì˜ê°€ ìˆìŠµë‹ˆë‹¤. `drizzle` í´ë”ì—ëŠ” Gelì—ì„œ Drizzle ìŠ¤í‚¤ë§ˆë¡œ ìƒì„±ëœ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### Step 1 - **Gel** í”„ë¡œì íŠ¸ ì„¤ì¹˜ ë° ì´ˆê¸°í™”

<Npx>
gel project init
</Npx>

#### Step 2 - ê¸°ë³¸ Gel ìŠ¤í‚¤ë§ˆ ì •ì˜

`dbschema/default.esdl` íŒŒì¼ì— ê¸°ë³¸ Gel ìŠ¤í‚¤ë§ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤

```esdl
module default {
    type user {
        name: str;
        required email: str;
        age: int16;
    }
}
```

#### Step 3 - Gel ìŠ¤í‚¤ë§ˆë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— í‘¸ì‹œ

Gel ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±:
```bash
gel migration create
```

Gel ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš©
```bash
gel migration apply
```

<Callout>
ì´ì œ ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ êµ¬ì¡°ë¥¼ ê°–ê²Œ ë©ë‹ˆë‹¤

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ dbschema
 â”‚ â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“œ default.esdl
 â”‚ â”” ğŸ“œ scoping.esdl
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ edgedb.toml
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```
</Callout>

#### Step 4 - í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
<Npm>
  drizzle-orm gel
  -D drizzle-kit tsx
</Npm>

#### Step 5 - Drizzle ì„¤ì • íŒŒì¼ ì„¤ì •

**Drizzle config** - [Drizzle Kit](/docs/kit-overview)ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì„¤ì • íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë” ë° ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
});
```

#### Step 6 - Gel íƒ€ì…ì„ Drizzle ìŠ¤í‚¤ë§ˆë¡œ í’€

ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ í’€í•©ë‹ˆë‹¤:
<Npx>
drizzle-kit pull
</Npx>

ë‹¤ìŒì€ ìƒì„±ëœ schema.ts íŒŒì¼ì˜ ì˜ˆì œì…ë‹ˆë‹¤:

```typescript filename="drizzle/schema.ts"
import { gelTable, uniqueIndex, uuid, smallint, text } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const users = gelTable("users", {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	age: smallint(),
	email: text().notNull(),
	name: text(),
}, (table) => [
	uniqueIndex("a8c6061c-f37f-11ef-9249-0d78f6c1807b;schemaconstr").using("btree", table.id.asc().nullsLast().op("uuid_ops")),
]);
```

#### Step 7 - Drizzle ORMì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°

`src` ë””ë ‰í† ë¦¬ì— `index.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ì—°ê²°ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤:

```typescript copy filename="src/index.ts"
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";

const gelClient = createClient();
const db = drizzle({ client: gelClient });
```

#### Step 8 - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬

```typescript copy filename="src/index.ts"
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";
import { users } from "../drizzle/schema";

const gelClient = createClient();
const db = drizzle({ client: gelClient });

async function main() {
  const user: typeof users.$inferInsert = {
    name: "John",
    age: 30,
    email: "john@example.com",
  };

  await db.insert(users).values(user);
  console.log("New user created!");

  const usersResponse = await db.select().from(users);
  console.log("Getting all users from the database: ", usersResponse);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(users)
    .set({
      age: 31,
    })
    .where(eq(users.email, user.email));
  console.log("User info updated!");

  await db.delete(users).where(eq(users.email, user.email));
  console.log("User deleted!");
}

main();
```

#### Step 9 - index.ts íŒŒì¼ ì‹¤í–‰

<RunFile/>