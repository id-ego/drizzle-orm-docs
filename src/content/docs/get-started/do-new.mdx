import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryTurso from '@mdx/get-started/sqlite/QueryTurso.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# Drizzle과 SQLite Durable Objects 시작하기

<Prerequisites>
  - **dotenv** - 환경 변수 관리 패키지 - [자세히 보기](https://www.npmjs.com/package/dotenv)
  - **tsx** - TypeScript 파일 실행 패키지 - [자세히 보기](https://tsx.is/)
  - **Cloudflare SQLite Durable Objects** - Durable Object 내에 내장된 SQLite 데이터베이스 - [자세히 보기](https://developers.cloudflare.com/durable-objects/api/sql-storage/)
  - **wrangler** - Cloudflare Developer Platform 커맨드라인 인터페이스 - [자세히 보기](https://developers.cloudflare.com/workers/wrangler)
</Prerequisites>

<FileStructure />

#### 1단계 - 필수 패키지 설치
<InstallPackages lib='wrangler'/>

#### 2단계 - wrangler.toml 설정

D1 데이터베이스를 위한 `wrangler.toml` 파일이 필요하며 다음과 같은 형태입니다:
```toml
#:schema node_modules/wrangler/config-schema.json
name = "sqlite-durable-objects"
main = "src/index.ts"
compatibility_date = "2024-11-12"
compatibility_flags = [ "nodejs_compat" ]

# Bind a Durable Object. Durable objects are a scale-to-zero compute primitive based on the actor model.
# Durable Objects can live for as long as needed. Use these when you need a long-running "server", such as in realtime apps.
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[[durable_objects.bindings]]
name = "MY_DURABLE_OBJECT"
class_name = "MyDurableObject"

# Durable Object migrations.
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["MyDurableObject"]

# We need rules so we can import migrations in the next steps
[[rules]] 
type = "Text"
globs = ["**/*.sql"]
fallthrough = true
```

#### 3단계 - Drizzle ORM을 데이터베이스에 연결

```ts
import { drizzle, type DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });
	}
}
```

#### 4단계 - wrangler 타입 생성

<Npx>
wrangler types
</Npx>

<Callout>
이 명령어의 출력 결과는 `worker-configuration.d.ts` 파일입니다.
</Callout>

#### 5단계 - 테이블 생성

<CreateTable/>

#### 6단계 - Drizzle 설정 파일 구성

**Drizzle config** - [Drizzle Kit](/docs/kit-overview)에서 사용하는 설정 파일이며, 데이터베이스 연결, 마이그레이션 폴더 및 스키마 파일에 대한 모든 정보를 포함합니다.

프로젝트 루트에 `drizzle.config.ts` 파일을 생성하고 다음 내용을 추가합니다:

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  driver: 'durable-sqlite',
});
```

#### 7단계 - 데이터베이스에 변경사항 적용

마이그레이션 생성:
```bash copy
npx drizzle-kit generate
```

마이그레이션은 Cloudflare Workers에서만 적용할 수 있습니다.
이를 위해 MyDurableObject에 마이그레이션 기능을 정의합니다:
```ts copy {4-5,17-19}
import { drizzle, type DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });
	}

	async migrate() {
		migrate(this.db, migrations);
	}
}
```

#### 8단계 - 데이터베이스 마이그레이션 및 쿼리

```typescript copy
import { drizzle, DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';
import { usersTable } from './db/schema';

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase<any>;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });

		// 쿼리를 수락하기 전에 모든 마이그레이션이 완료되었는지 확인합니다.
		// 그렇지 않으면 Drizzle 데이터베이스 `this.db`에 접근하는 모든 함수에서
		// `this.migrate()`를 실행해야 합니다.
		ctx.blockConcurrencyWhile(async () => {
			await this._migrate();
		});
	}

	async insertAndList(user: typeof usersTable.$inferInsert) {
		await this.insert(user);
		return this.select();
	}

	async insert(user: typeof usersTable.$inferInsert) {
		await this.db.insert(usersTable).values(user);
	}

	async select() {
		return this.db.select().from(usersTable);
	}

	async _migrate() {
		migrate(this.db, migrations);
	}
}

export default {
	/**
	 * Cloudflare Worker의 표준 fetch 핸들러
	 *
	 * @param request - 클라이언트에서 Worker로 제출된 요청
	 * @param env - wrangler.toml에 선언된 바인딩을 참조하는 인터페이스
	 * @param ctx - Worker의 실행 컨텍스트
	 * @returns 클라이언트에 전송될 응답
	 */
	async fetch(request: Request, env: Env): Promise<Response> {
		const id: DurableObjectId = env.MY_DURABLE_OBJECT.idFromName('durable-object');
		const stub = env.MY_DURABLE_OBJECT.get(id);

		// 옵션 A - 최대 성능.
		// DO 내에서 데이터베이스 접근이 빠르기 때문에,
		// 모든 데이터베이스 상호작용을 하나의 Durable Object 호출로 묶는 것이 최대 성능을 위해 권장됩니다.
		const usersAll = await stub.insertAndList({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('New user created. Getting all users from the database: ', users);

		// 옵션 B - 느리지만 디버깅에 유용할 수 있습니다.
		// 노출된 개별 Drizzle 쿼리를 직접 호출할 수도 있지만,
		// 모든 쿼리가 Durable Object 인스턴스로의 왕복임을 유의하세요.
		await stub.insert({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('New user created!');

		const users = await stub.select();
		console.log('Getting all users from the database: ', users);

		return Response.json(users);
	}
}
```