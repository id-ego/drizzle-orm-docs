import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# Drizzleê³¼ Expo ì‹œì‘í•˜ê¸°

<Prerequisites>
  - **Expo SQLite** - SQLite APIë¥¼ í†µí•´ ì¿¼ë¦¬í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ - [ìì„¸íˆ ë³´ê¸°](https://docs.expo.dev/versions/latest/sdk/sqlite/)
</Prerequisites>


#### Step 1 - Expo í…œí”Œë¦¿ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì„¤ì •
<Npx>
create expo-app --template blank-typescript
</Npx>

ì´ í…œí”Œë¦¿ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://docs.expo.dev/more/create-expo/#create-a-new-project)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°

í…œí”Œë¦¿ì„ ì„¤ì¹˜í•˜ê³  `db` í´ë”ë¥¼ ì¶”ê°€í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ê°€ ìƒì„±ë©ë‹ˆë‹¤. `db/schema.ts` íŒŒì¼ì—ëŠ” Drizzle í…Œì´ë¸” ì •ì˜ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, `drizzle` í´ë”ì—ëŠ” SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ê³¼ ìŠ¤ëƒ…ìƒ·ì´ í¬í•¨ë©ë‹ˆë‹¤.

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ assets
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ db
 â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“œ .gitignore
 â”œ ğŸ“œ .npmrc
 â”œ ğŸ“œ app.json
 â”œ ğŸ“œ App.tsx
 â”œ ğŸ“œ babel.config.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### Step 2 - expo-sqlite íŒ¨í‚¤ì§€ ì„¤ì¹˜
<Npx>
expo install expo-sqlite
</Npx>

#### Step 3 - í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
<Npm>
  drizzle-orm
  -D drizzle-kit
</Npm>

#### Step 4 - ë°ì´í„°ë² ì´ìŠ¤ì— Drizzle ORM ì—°ê²°

ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— `App.tsx` íŒŒì¼ì„ ìƒì„±í•˜ê³  ì—°ê²°ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤:

```ts
import * as SQLite from 'expo-sqlite';
import { drizzle } from 'drizzle-orm/expo-sqlite';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);
```

#### Step 5 - í…Œì´ë¸” ìƒì„±

`db` ë””ë ‰í† ë¦¬ì— `schema.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  í…Œì´ë¸”ì„ ì •ì˜í•©ë‹ˆë‹¤:

```typescript copy filename="src/db/schema.ts"
import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable("users_table", {
  id: int().primaryKey({ autoIncrement: true }),
  name: text().notNull(),
  age: int().notNull(),
  email: text().notNull().unique(),
});
```

#### Step 6 - Drizzle ì„¤ì • íŒŒì¼ ì„¤ì •

**Drizzle config** - [Drizzle Kit](/docs/kit-overview)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì„¤ì • íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë” ë° ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'sqlite',
  driver: 'expo',
  schema: './db/schema.ts',
  out: './drizzle',
});
```

#### Step 7 - `metro` ì„¤ì •

ë£¨íŠ¸ í´ë”ì— `metro.config.js` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:

```js copy filename="metro.config.js"
const { getDefaultConfig } = require('expo/metro-config');
/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

#### Step 8 - `babel` ì„¤ì • ì—…ë°ì´íŠ¸
```js copy filename="babel.config.js"
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [["inline-import", { "extensions": [".sql"] }]] // <-- add this
  };
};
```

#### Step 9 - ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš©

Expoì—ì„œëŠ” `drizzle-kit generate` ëª…ë ¹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•œ ë‹¤ìŒ, ëŸ°íƒ€ì„ì— `drizzle-orm`ì˜ `migrate()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±:
```bash copy
npx drizzle-kit generate
```

#### Step 10 - ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ë° ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬

ì‚¬ìš©ìë¥¼ ìƒì„±, ì¡°íšŒ, ì—…ë°ì´íŠ¸ ë° ì‚­ì œí•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ ì¿¼ë¦¬ê°€ í¬í•¨ëœ **App.tsx** íŒŒì¼ì„ ì‘ì„±í•´ë´…ì‹œë‹¤.

```ts copy
import { Text, View } from 'react-native';
import * as SQLite from 'expo-sqlite';
import { useEffect, useState } from 'react';
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { usersTable } from './db/schema';
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import migrations from './drizzle/migrations';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);

export default function App() {
  const { success, error } = useMigrations(db, migrations);
  const [items, setItems] = useState<typeof usersTable.$inferSelect[] | null>(null);

  useEffect(() => {
    if (!success) return;

    (async () => {
      await db.delete(usersTable);

      await db.insert(usersTable).values([
        {
            name: 'John',
            age: 30,
            email: 'john@example.com',
        },
      ]);

      const users = await db.select().from(usersTable);
      setItems(users);
    })();
  }, [success]);

  if (error) {
    return (
      <View>
        <Text>Migration error: {error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>Migration is in progress...</Text>
      </View>
    );
  }

  if (items === null || items.length === 0) {
    return (
      <View>
        <Text>Empty</Text>
      </View>
    );
  }

  return (
    <View
      style={{
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        width: '100%',
        height: '100%',
        justifyContent: 'center',
      }}
    >
      {items.map((item) => (
        <Text key={item.id}>{item.email}</Text>
      ))}
    </View>
  );
}
```

#### Step 11 - Expo ì•± í”„ë¦¬ë¹Œë“œ ë° ì‹¤í–‰

<CodeTabs items={['npm', 'yarn', 'pnpm', 'bun']}>
```bash copy
npx expo run:ios
```
```bash copy
yarn expo run:ios
```
```bash copy
pnpm expo run:ios
```
```bash copy
bun expo run:ios
```
</CodeTabs>
