---
title: "Drizzleê³¼ Vercel Postgres"
date: "2024-06-09"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5L4 19H20L12 5Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>]
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

ì´ íŠœí† ë¦¬ì–¼ì€ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)ì™€ í•¨ê»˜ Drizzle ORMì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤. Vercel PostgresëŠ” Vercel Functions ë° í”„ë¡ íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬ì™€ í†µí•©ë˜ë„ë¡ ì„¤ê³„ëœ ì„œë²„ë¦¬ìŠ¤ SQL ë°ì´í„°ë² ì´ìŠ¤ì…ë‹ˆë‹¤.

<Prerequisites>
- Drizzle ORMê³¼ [Drizzle kit](/docs/kit-overview)ì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- í™˜ê²½ ë³€ìˆ˜ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ `dotenv` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ íŒ¨í‚¤ì§€ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://www.npmjs.com/package/dotenv)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”
<Npm>
  dotenv
</Npm>

- `@vercel/postgres` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ íŒ¨í‚¤ì§€ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://www.npmjs.com/package/@vercel/postgres)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”
<Npm>
  @vercel/postgres
</Npm>
</Prerequisites>

Drizzle ORMìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ëŠ” ë°©ë²•ì€ [Vercel ë¬¸ì„œ](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

## Vercel Postgresì™€ Drizzle ORM ì„¤ì •

<Steps>
#### ìƒˆë¡œìš´ Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±

[ëŒ€ì‹œë³´ë“œ](https://vercel.com/dashboard)ì—ì„œ ìƒˆë¡œìš´ Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì€ Vercel Postgres [ë¬¸ì„œ](https://vercel.com/docs/storage/vercel-postgres/quickstart)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

#### ì—°ê²° ë¬¸ìì—´ ë³€ìˆ˜ ì„¤ì •

Vercel Postgres ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì´ë™í•˜ì—¬ `.env.local` ì„¹ì…˜ì—ì„œ `POSTGRES_URL`ì„ ë³µì‚¬í•©ë‹ˆë‹¤.

`POSTGRES_URL`ì„ `.env.local` ë˜ëŠ” `.env` íŒŒì¼ì— ì¶”ê°€í•©ë‹ˆë‹¤.

```plaintext copy
POSTGRES_URL=<YOUR_DATABASE_URL>
```

#### Drizzle ORMì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°

`src/db` ë””ë ‰í† ë¦¬ì— `index.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ êµ¬ì„±í•©ë‹ˆë‹¤:

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { config } from 'dotenv';

config({ path: '.env.local' }); // or .env

export const db = drizzle();

```

#### í…Œì´ë¸” ìƒì„±

`src/db` ë””ë ‰í† ë¦¬ì— `schema.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  í…Œì´ë¸”ì„ ì •ì˜í•©ë‹ˆë‹¤:

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### Drizzle ì„¤ì • íŒŒì¼ êµ¬ì„±

**Drizzle config** - [Drizzle Kit](/docs/kit-overview)ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì„¤ì • íŒŒì¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ë§ˆì´ê·¸ë ˆì´ì…˜ í´ë” ë° ìŠ¤í‚¤ë§ˆ íŒŒì¼ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `drizzle.config.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env.local' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

#### ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš©

`drizzle-kit generate` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•œ ë‹¤ìŒ `drizzle-kit migrate` ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±:

```bash copy
npx drizzle-kit generate
```

ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ `drizzle.config.ts`ì— ì§€ì •ëœ ëŒ€ë¡œ `drizzle/migrations` ë””ë ‰í† ë¦¬ì— ì €ì¥ë©ë‹ˆë‹¤. ì´ ë””ë ‰í† ë¦¬ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë° í•„ìš”í•œ SQL íŒŒì¼ê³¼ ë‹¤ì–‘í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ì—ì„œ ìŠ¤í‚¤ë§ˆ ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥í•˜ëŠ” `meta` í´ë”ê°€ í¬í•¨ë©ë‹ˆë‹¤.

ìƒì„±ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì œ:

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰:

```bash copy
npx drizzle-kit migrate
```

ë˜ëŠ” [Drizzle kit push ëª…ë ¹ì–´](/docs/kit-overview#prototyping-with-db-push)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ë³€ê²½ì‚¬í•­ì„ í‘¸ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push ëª…ë ¹ì–´ëŠ” ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ìƒˆë¡œìš´ ìŠ¤í‚¤ë§ˆ ë””ìì¸ì´ë‚˜ ë³€ê²½ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•´ì•¼ í•˜ëŠ” ìƒí™©ì— ì í•©í•˜ë©°, ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê´€ë¦¬ì˜ ì˜¤ë²„í—¤ë“œ ì—†ì´ ë¹ ë¥¸ ë°˜ë³µì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</Callout>

</Steps>

## ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°

ì´ê²ƒì€ í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ íŒŒì¼ êµ¬ì¡°ì…ë‹ˆë‹¤. `src/db` ë””ë ‰í† ë¦¬ì—ëŠ” `index.ts`ì˜ ì—°ê²° ì„¤ì •ê³¼ `schema.ts`ì˜ ìŠ¤í‚¤ë§ˆ ì •ì˜ë¥¼ í¬í•¨í•œ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤.

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env.local
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## ì¿¼ë¦¬ ì˜ˆì œ

ì˜ˆë¥¼ ë“¤ì–´, `src/db/queries` í´ë”ë¥¼ ìƒì„±í•˜ê³  ê° ì‘ì—…(insert, select, update, delete)ì— ëŒ€í•œ íŒŒì¼ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.

#### ë°ì´í„° ì‚½ì…

ì‚½ì… ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/insert)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### ë°ì´í„° ì¡°íšŒ

ì¡°íšŒ ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/select)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

<Callout type='warning'>
`getColumns`ëŠ” `drizzle-orm@1.0.0-beta.2`ë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤([ì—¬ê¸°](/docs/upgrade-v1)ì—ì„œ ìì„¸íˆ í™•ì¸)

1.0 ì´ì „ ë²„ì „(ì˜ˆ: `0.45.1`)ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° `getTableColumns`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

ë˜ëŠ” [ê´€ê³„í˜• ì¿¼ë¦¬ ë¬¸ë²•](/docs/rqb)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ë°ì´í„° ì—…ë°ì´íŠ¸

ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/update)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### ë°ì´í„° ì‚­ì œ

ì‚­ì œ ì¿¼ë¦¬ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¬¸ì„œ](/docs/delete)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```
